{% extends "base.html" %}

{% block title %}Calls for Service Dashboard - SATX Data{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="container">
    <header>
        <h1>SAPD Calls for Service Dashboard</h1>
        <p class="subtitle">Last 30 Days Call Statistics</p>
        <div class="last-update">
            {% if last_fetch and last_fetch.fetch_date_formatted %}
                Last updated: {{ last_fetch.fetch_date_formatted }}
            {% else %}
                No data available
            {% endif %}
        </div>
    </header>

    <div class="stats-grid">
        <div class="stat-card total-crimes">
            <h3>Total Calls</h3>
            <div class="stat-number">{{ "{:,}".format(stats.total_calls) }}</div>
            <p class="stat-label">in the last 30 days</p>
        </div>

        <div class="stat-card violent-crimes">
            <h3>Emergency Calls</h3>
            <div class="stat-number">{{ "{:,}".format(stats.emergency_calls) }}</div>
            <p class="stat-label">{{ "%.1f"|format(emergency_percentage) }}% of total</p>
        </div>

        <div class="stat-card daily-average">
            <h3>Daily Average</h3>
            <div class="stat-number">{{ "{:,}".format((stats.total_calls / 30)|int) }}</div>
            <p class="stat-label">calls per day</p>
        </div>

        {% if stats.avg_response_minutes %}
        <div class="stat-card" style="background: #f8f9fa;">
            <h3>Avg Response Time</h3>
            <div class="stat-number" style="color: #9b59b6;">{{ "%.1f"|format(stats.avg_response_minutes) }}</div>
            <p class="stat-label">minutes</p>
        </div>
        {% endif %}
    </div>

    <div class="charts-grid">
        <div class="chart-container">
            <h3>Top 10 Problem Types</h3>
            <canvas id="problemTypesChart"></canvas>
        </div>

        <div class="chart-container">
            <h3>Calls by Priority</h3>
            <canvas id="priorityChart"></canvas>
        </div>

        <div class="chart-container">
            <h3>Emergency vs Non-Emergency</h3>
            <canvas id="callTypeChart"></canvas>
        </div>

        <div class="chart-container">
            <h3>Calls by Service Area</h3>
            <canvas id="serviceAreaChart"></canvas>
        </div>

        <div class="chart-container">
            <h3>Daily Call Volume Trend</h3>
            <canvas id="dailyTrendChart"></canvas>
        </div>

        <div class="chart-container">
            <h3>Top Disposition Types</h3>
            <canvas id="dispositionChart"></canvas>
        </div>
    </div>

    <div class="tables-grid">
        <div class="table-container">
            <h3>Top 10 Problem Types</h3>
            <table>
                <thead>
                    <tr>
                        <th>Problem Type</th>
                        <th>Count</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    {% for problem, count in stats.calls_by_problem[:10] %}
                    <tr>
                        <td>{{ problem }}</td>
                        <td>{{ "{:,}".format(count) }}</td>
                        <td>{{ "%.1f"|format((count / stats.total_calls * 100) if stats.total_calls > 0 else 0) }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="table-container">
            <h3>Top 10 Zip Codes</h3>
            <table>
                <thead>
                    <tr>
                        <th>Zip Code</th>
                        <th>Call Count</th>
                    </tr>
                </thead>
                <tbody>
                    {% for zip_code, count in stats.top_zip_codes %}
                    <tr>
                        <td>{{ zip_code }}</td>
                        <td>{{ "{:,}".format(count) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Problem Types Chart
        const problemTypesCtx = document.getElementById('problemTypesChart').getContext('2d');
        new Chart(problemTypesCtx, {
            type: 'bar',
            data: {
                labels: {{ problem_labels | tojson }},
                datasets: [{
                    label: 'Number of Calls',
                    data: {{ problem_data | tojson }},
                    backgroundColor: 'rgba(155, 89, 182, 0.6)',
                    borderColor: 'rgba(155, 89, 182, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        });

        // Priority Chart
        const priorityCtx = document.getElementById('priorityChart').getContext('2d');
        new Chart(priorityCtx, {
            type: 'bar',
            data: {
                labels: {{ priority_labels | tojson }},
                datasets: [{
                    label: 'Number of Calls',
                    data: {{ priority_data | tojson }},
                    backgroundColor: [
                        'rgba(231, 76, 60, 0.6)',
                        'rgba(230, 126, 34, 0.6)',
                        'rgba(241, 196, 15, 0.6)',
                        'rgba(46, 204, 113, 0.6)',
                        'rgba(52, 152, 219, 0.6)'
                    ],
                    borderColor: [
                        'rgba(231, 76, 60, 1)',
                        'rgba(230, 126, 34, 1)',
                        'rgba(241, 196, 15, 1)',
                        'rgba(46, 204, 113, 1)',
                        'rgba(52, 152, 219, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Call Type Chart
        const callTypeCtx = document.getElementById('callTypeChart').getContext('2d');
        new Chart(callTypeCtx, {
            type: 'pie',
            data: {
                labels: {{ type_labels | tojson }},
                datasets: [{
                    data: {{ type_data | tojson }},
                    backgroundColor: [
                        'rgba(231, 76, 60, 0.6)',
                        'rgba(52, 152, 219, 0.6)'
                    ],
                    borderColor: [
                        'rgba(231, 76, 60, 1)',
                        'rgba(52, 152, 219, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Service Area Chart
        const serviceAreaCtx = document.getElementById('serviceAreaChart').getContext('2d');
        new Chart(serviceAreaCtx, {
            type: 'bar',
            data: {
                labels: {{ area_labels | tojson }},
                datasets: [{
                    label: 'Number of Calls',
                    data: {{ area_data | tojson }},
                    backgroundColor: 'rgba(142, 68, 173, 0.6)',
                    borderColor: 'rgba(142, 68, 173, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Daily Trend Chart
        const dailyTrendCtx = document.getElementById('dailyTrendChart').getContext('2d');
        new Chart(dailyTrendCtx, {
            type: 'line',
            data: {
                labels: {{ trend_labels | tojson }},
                datasets: [{
                    label: 'Daily Call Volume',
                    data: {{ trend_data | tojson }},
                    borderColor: 'rgba(155, 89, 182, 1)',
                    backgroundColor: 'rgba(155, 89, 182, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        });

        // Disposition Chart
        const dispositionCtx = document.getElementById('dispositionChart').getContext('2d');
        new Chart(dispositionCtx, {
            type: 'doughnut',
            data: {
                labels: {{ disposition_labels | tojson }},
                datasets: [{
                    data: {{ disposition_data | tojson }},
                    backgroundColor: [
                        'rgba(46, 204, 113, 0.6)',
                        'rgba(52, 152, 219, 0.6)',
                        'rgba(155, 89, 182, 0.6)',
                        'rgba(241, 196, 15, 0.6)',
                        'rgba(231, 76, 60, 0.6)'
                    ],
                    borderColor: [
                        'rgba(46, 204, 113, 1)',
                        'rgba(52, 152, 219, 1)',
                        'rgba(155, 89, 182, 1)',
                        'rgba(241, 196, 15, 1)',
                        'rgba(231, 76, 60, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });
    </script>
</div>
{% endblock %}